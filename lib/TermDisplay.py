#!/usr/bin/env python3.3
# -*- coding: utf8 -*-
#
# Terminal component of CVE-Scan. Takes a list of scanned hosts as
# input and uses the terminal to displays this information in a
# graphical manner, enhancing it with information from the CVE-Search
# database and ToolsWatch Default Password Enumeration (DPE) list.
#
# Copyright (c) 2015	NorthernSec
# Copyright (c) 2015	Pieter-Jan Moreels
# This software is licensed under the Original BSD Licence

# Imports
import os
import sys
runpath = os.path.dirname(os.path.realpath(__file__))

import curses
from time import sleep
from lib.Toolkit import make_dict, enhance

# Class
class TermDisplay():
  @classmethod
  def start(self, systems=None):
    try:
      scr=curses.initscr()
      curses.start_color()
      curses.init_pair(1, curses.COLOR_RED,curses.COLOR_BLACK)
      curses.init_pair(2, curses.COLOR_BLUE, curses.COLOR_BLACK)
      curses.init_pair(3, curses.COLOR_WHITE, curses.COLOR_BLACK)
      curses.init_pair(4, curses.COLOR_GREEN, curses.COLOR_BLACK)
      curses.init_pair(5, curses.COLOR_YELLOW, curses.COLOR_BLACK)
      md_b   =curses.A_BOLD | curses.color_pair(1)
      md_bt  =curses.A_BOLD | curses.color_pair(2)
      md_cont=curses.A_BOLD | curses.A_BLINK
      md_head=curses.A_BOLD | curses.color_pair(2)
      md_norm=curses.color_pair(3)
      md_mark=curses.color_pair(1)
      md_bad=curses.color_pair(1)
      md_med=curses.color_pair(5)
      md_good=curses.color_pair(4)
      curses.curs_set(0)
      curses.noecho()
      scr.keypad(1)
    except Exception as ex:
      curses.endwin()
      raise Exception(ex)

    # Init sub functions
    def printWelcome():
      scr.clear()
      scr.border(1)
      maxy,maxx=scr.getmaxyx()
      if maxy<10:raise("Please make sure your terminal has at least 10 rows")
      anykey=int(((maxy-7)/2+8))
      start=int((maxx/2)-24)
      scr.addstr(2,start," _____ _   _ _____      _____                 ",md_b)
      scr.addstr(3,start,"/  __ \ | | |  ___|    /  ___|                ",md_b)
      scr.addstr(4,start,"| /  \/ | | | |__ _____\ `--.  ___ __ _ _ __  ",md_b)
      scr.addstr(5,start,"| |   | | | |  __|_____|`--. \/ __/ _` | '_ \ ",md_b)
      scr.addstr(6,start,"| \__/\ \_/ / |___     /\__/ / (_| (_| | | | |",md_b)
      scr.addstr(7,start," \____/\___/\____/     \____/ \___\__,_|_| |_|",md_b)
      scr.addstr(8,start,"                            (c) NorthernSec   ",md_bt)
      scr.addstr(anykey,start,"             [Press the any key]              ",md_cont)
      scr.refresh()
      scr.getch()

    def printHelp(section=None):
      if not section:
        text=[{'t':'----------','m':md_head},
              {'t':'|  HELP  |','m':md_head},
              {'t':'----------','m':md_head},
              {'t':' '},
              {'t':'Navigating','m':md_head},
              {'t':' * You can navigate through the scanned systems with p and n, or the left and right arrow key'},
              {'t':' * You can scroll through the current system with u and d, or the up and down arrow key'},
              {'t':' * You can jump directly to a scanned system by entering the page number with j, and entering the page number.'},
              {'t':' '},
              {'t':'Commands','m':md_head},
              {'t':'By pressing c, you can enter commands:'},
              {'t':'  help     Displays this menu'}]
      f=[' - press q to return to the previous page -']
      scroll(text,footer=f)
    def scroll(text,footer=[],cursor=False,limit=True):
      contInd=0
      cursInd=0
      cursPos=0
      while True:
        maxy,maxx=scr.getmaxyx()
        maxCont=maxy-len(footer)-4
        scr.clear()
        lines=list(text)
        if len(text)>maxCont:
          lines=lines[contInd:contInd+maxCont]

        for i,line in enumerate(lines):
          markup=line['m'] if 'm' in line else md_norm
          if 't' in line:
            scr.addstr(i+2,2,line['t'],markup)
          elif 'f' in line and 'v' in line:
            scr.addstr(i+2,2,line['f'],md_head)
            scr.addstr(i+2,14,str(line['v'])[:maxx-4],markup)
          else:
            scr.addstr(i+2,2,"Line is an invalid format")
        if cursor:
          scr.addstr(cursPos+2,1,">")
        for i,line in enumerate(footer):
          scr.addstr((maxy-len(footer)-1)+i,2,line)

        x=scr.getch()
        if x==ord('u') or x==curses.KEY_UP:
          if cursor:
            if cursInd>0:cursInd-=1
            if cursPos>0:cursPos-=1
            if cursPos==0 and contInd>0:contInd-=1
          else:
            if contInd>0:contInd-=1
        elif x==ord('d') or x==curses.KEY_DOWN:
          if cursor:
            if cursInd<len(text)-1:cursInd+=1
            if cursPos<maxCont and cursPos<len(text)-1:cursPos+=1
            if cursPos==maxCont and (len(text)-contInd)>maxCont:contInd+=1
          else:
            if (len(text)-contInd)>maxCont:contInd+=1
        elif x==ord('q'):
          return ord('q') if limit else (ord('q'),cursInd)
        else:
          if not limit:
            return (x,cursInd)

    def cvesForcpe(cpe,service=None):
      scroll(cpe)
      

    def product(banner):
      if banner:
        r=make_dict(banner)
        return r['product']
      else:
        return 'Unknown'

    def getLinesFor(sys):
      cpes=sys['cpes'] if 'cpes' in sys else ['Not Detected']
      mac=sys['mac'] if sys['mac'] else 'Unknown'
      marked=md_mark if 'cves' in cpes[0] else md_norm
      cont=[({'f':'IP',     'v':sys['ip']}),
            ({'f':'MAC',    'v':mac}),
            ({'f':'Status', 'v':sys['status']}),
            ({'f':'CPEs',   'v':cpes[0],       'm':marked})]
      if len(cpes)>1:
        for cpe in cpes[1:]:
          marked=md_mark if 'cves' in cpe else md_norm
          cont.append({'f':' ', 'v':cpe, 'm':marked})
      cont.append({'f':'Vendor', 'v':sys['vendor']})
      hosts=sys['hostnames'] if 'hostnames' in sys else ['None']
      cont.append({'f':'Hostnames', 'v':hosts[0]})
      for host in hosts[1:]:
        cont.append({'f':' ',  'v':host})
      cont.append({'f':'Distance', 'v':sys['distance']})
      serv=sys['services'] if 'services' in sys else ['No services found']
      s=serv[0]
      ser='%s (%s/%s) is %s'%(s['name'],s['port'],s['protocol'],s['state'])
      marked=md_mark if len(s['cves'])>0 else md_norm
      cont.append({'f':'Services', 'v':ser, 'm':marked})
      cont.append({'f':' ', 'v':' > %s'%product(s['banner']), 'm':marked})
      for s in serv[1:]:
        marked=md_mark if len(s['cves'])>0 else md_norm
        ser='%s (%s/%s) is %s'%(s['name'],s['port'],s['protocol'],s['state'])
        cont.append({'f':' ', 'v':ser, 'm':marked})
        cont.append({'f':' ', 'v':' > %s'%product(s['banner']), 'm':marked})

      return cont

    def cveView(cves):
      scroll(cves)

    def home():
      ind=0
      contInd=0
      while True:
        sys=systems[ind]
        content=getLinesFor(sys)
        foot=["(u)p   | (n)ext    | (p)revious | (q)uit",
              "(d)own | (j)ump to | (c)ommand  | [%s/%s]"%(ind+1,len(systems)),
              " "]
        x,index = scroll(content,footer=foot,cursor=True,limit=False)
        if x==ord('n') or x==curses.KEY_RIGHT:
          ind+=1
          if ind>=len(systems):ind=0
        elif x==ord('p') or x==curses.KEY_LEFT:
          ind-=1
          if ind<0:ind=len(systems)-1
        elif x==ord('q'):
          break
        elif x==ord('c'):
          maxy,maxx=scr.getmaxyx()
          curses.echo()
          scr.addstr(maxy-2,3,'>')
          line=scr.getstr(maxy-2,5).strip().lower()
          line=str(line,'utf-8')
          l=line.split(' ')
          c=l[0]
          args=l[1:]
          if c in ['help', 'h']:
            printHelp()
          elif c in ['cpe', 'c']:
            scr.addstr(2,2,content[index]['v'])
            scr.getch()
          elif c=='test':
            scr.addstr(2,2,str(args))
            scr.getch()
          else:
            error='Invalid Command'
            scr.addstr(int(maxy/2),int(maxx/2-len(error)/2),error,md_bad)
            scr.getch()
          curses.noecho()
        else:
          scr.addstr(2,2,("%s %s"%(x, chr(x))))
          scr.getch()

    try:
      printWelcome()
      home()
      curses.endwin()
    except Exception as ex:
      curses.endwin()
      raise Exception(ex)
