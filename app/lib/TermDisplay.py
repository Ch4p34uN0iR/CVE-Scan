#!/usr/bin/env python3.3
# -*- coding: utf8 -*-
#
# Terminal component of CVE-Scan. Takes a list of scanned hosts as
# input and uses the terminal to displays this information in a
# graphical manner, enhancing it with information from the CVE-Search
# database and ToolsWatch Default Password Enumeration (DPE) list.
#
# Copyright (c) 2015	NorthernSec
# Copyright (c) 2015	Pieter-Jan Moreels
# This software is licensed under the Original BSD Licence

# Imports
import os
import sys
runpath = os.path.dirname(os.path.realpath(__file__))

import curses
from time import sleep

# Class
class TermDisplay():
  @classmethod
  def start(self, systems=None):
    try:
      scr=curses.initscr()
      curses.start_color()
      curses.init_pair(1, curses.COLOR_RED, curses.COLOR_BLACK)
      curses.init_pair(2, curses.COLOR_BLUE, curses.COLOR_BLACK)
      md_b   =curses.A_BOLD | curses.color_pair(1)
      md_bt  =curses.A_BOLD | curses.color_pair(2)
      mb_cont=curses.A_BOLD | curses.A_BLINK
      curses.curs_set(0)

      # Init sub functions
      def printWelcome():
        scr.clear()
        scr.border(1)
        scr.addstr( 2,5," _____ _   _ _____      _____                 ",md_b)
        scr.addstr( 3,5,"/  __ \ | | |  ___|    /  ___|                ",md_b)
        scr.addstr( 4,5,"| /  \/ | | | |__ _____\ `--.  ___ __ _ _ __  ",md_b)
        scr.addstr( 5,5,"| |   | | | |  __|_____|`--. \/ __/ _` | '_ \ ",md_b)
        scr.addstr( 6,5,"| \__/\ \_/ / |___     /\__/ / (_| (_| | | | |",md_b)
        scr.addstr( 7,5," \____/\___/\____/     \____/ \___\__,_|_| |_|",md_b)
        scr.addstr( 8,5,"                            (c) NorthernSec   ",md_bt)
        scr.addstr(20,5,"             [Press the any key]              ",mb_cont)
        scr.refresh()
        scr.getch()

      def home():
        ind=0
        while True:
          maxy,maxx=scr.getmaxyx()
          scr.clear()
          sys=systems[ind]
          cpes=sys['cpes'] if 'cpes' in sys else ['Not Detected']
          mac=sys['mac'] if sys['mac'] else 'Unknown'
          cont=[('IP     %s'%(sys['ip'])),
                ('MAC    %s'%mac),
                ('Status %s'%sys['status']),
                ('CPEs   %s'%cpes)]
          if len(cpes)>1:
            for cpe in cpes[1:]:
              cont.append('      %s'%cpe)
          cont.append('Vendor %s'%sys['vendor'])
          
          scr.addstr(maxy-2,2,("(j)ump to | (n)ext | (p)revious | (c)ommand  [%s]")%ind)
          x=scr.getch()
          if x==ord('n'):
            ind+=1
            if ind>=len(systems):ind=0
          elif x==ord('p'):
            ind-=1
            if ind<0:ind=len(systems)-1
          else:
            scr.addstr(2,2,("%s %s %s"%(x, chr(x), ord('j'))))
            scr.getch()
            break

      printWelcome()
      home()
      curses.endwin()
    except Exception as ex:
      curses.endwin()
      print(sys.exc_info()[0])
      raise Exception(ex)
