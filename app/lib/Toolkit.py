#!/usr/bin/env python3.3
# -*- coding: utf8 -*-
#
# Toolkit script for all types of functions, needed throughout the project
#
# Copyright (c) 2015	NorthernSec
# Copyright (c)	2015	Pieter-Jan Moreels
# This software is licensed under the Original BSD License

# Imports
import re
from dateutil import tz
import dateutil.parser
from Config import Configuration

# string to dict
def make_dict(s):
  # break into list of keys and values
  chunks = re.split('\s*(\w+\:)\s*',s)
  res={}
  # work backwards in value, key pairs
  args=[reversed(chunks)]*2
  for value,key in zip(*args):
    key=key.rstrip(':')
    if value:
      #add to current result-dict
      res[key]=value
    else:
      #start a higher-level result-dict
      res={key:res}
  return res

def toLocalTime(utc):
  timezone = tz.tzlocal()
  utc = dateutil.parser.parse(utc)
  output = utc.astimezone(timezone)
  output = output.strftime('%d-%m-%Y - %H:%M')
  return output

def enhance(systems):
  connect = Configuration.getMongoConnection()
  col=connect['cves']
  for system in systems:
    cpe=system['cpes'] if 'cpes' in system else None
    if cpe:
      cpes=[]
      for c in cpe:
        vulns = list(col.find({'vulnerable_configuration': c},{'id':1, 'impact':1, 'access':1}))
        print(c)
        cpes.append({'cpe':c, 'cves':vulns})
      system['cpes']=cpes
      #get possible dpe info and store in dpe
    for service in system['services']:
      if 'cpe' in service:
        service['cves']=list(col.find({'vulnerable_configuration':service['cpe']},{'id':1, 'impact':1, 'access':1}))
      #get dpe info for service
  return systems

